Raphael.fn.connection=function(b,X,Y){var P=this,D={draw:function(){for(var t=b.getBBox(),e=X.getBBox(),i=[{x:t.x+t.width/2,y:t.y-0},{x:t.x+t.width/2,y:t.y+t.height+0},{x:t.x-0,y:t.y+t.height/2},{x:t.x+t.width+0,y:t.y+t.height/2},{x:e.x+e.width/2,y:e.y-0},{x:e.x+e.width/2,y:e.y+e.height+0},{x:e.x-0,y:e.y+e.height/2},{x:e.x+e.width+0,y:e.y+e.height/2}],a={},o=[],s=0;s<4;s++)for(var h=4;h<8;h++){var r=Math.abs(i[s].x-i[h].x),n=Math.abs(i[s].y-i[h].y);(s==h-4||(3!=s&&6!=h||i[s].x<i[h].x)&&(2!=s&&7!=h||i[s].x>i[h].x)&&(0!=s&&5!=h||i[s].y>i[h].y)&&(1!=s&&4!=h||i[s].y<i[h].y))&&(o.push(r+n),a[o[o.length-1].toFixed(3)]=[s,h])}var d=0==o.length?[0,4]:a[Math.min.apply(Math,o).toFixed(3)],l=i[d[0]].x,u=i[d[0]].y,c=i[d[1]].x,g=i[d[1]].y,p=(r=Math.max(Math.abs(l-c)/2,10),n=Math.max(Math.abs(u-g)/2,10),[l,l,l-r,l+r][d[0]].toFixed(3)),y=[u-n,u+n,u,u][d[0]].toFixed(3),f=[0,0,0,0,c,c,c-r,c+r][d[1]].toFixed(3),x=[0,0,0,0,u+n,u-n,g,g][d[1]].toFixed(3),v=["M",l.toFixed(3),u.toFixed(3),"C",p,y,f,x,c.toFixed(3),g.toFixed(3)].join(",");if(Y&&Y.directed){function w(t,e){return-t*(e||5)/M}var M=Math.sqrt((g-x)*(g-x)+(c-f)*(c-f)),F=[{x:(w(c-f)+w(g-x)+c).toFixed(3),y:(w(g-x)+w(c-f)+g).toFixed(3)},{x:(w(c-f)-w(g-x)+c).toFixed(3),y:(w(g-x)-w(c-f)+g).toFixed(3)}];v=v+",M"+F[0].x+","+F[0].y+",L"+c+","+g+",L"+F[1].x+","+F[1].y}var m="attr";D.fg&&D.fg[m]({path:v})||(D.fg=P.path(v).attr({stroke:Y&&Y.stroke||"#000",fill:"none"}).toBack()),D.bg&&D.bg[m]({path:v})||Y&&Y.fill&&(D.bg=Y.fill.split&&P.path(v).attr({stroke:Y.fill.split("|")[0],fill:"none","stroke-width":Y.fill.split("|")[1]||3}).toBack()),Y&&Y.label&&(D.label&&D.label.attr({x:(l+c)/2,y:(u+g)/2})||(D.label=P.text((l+c)/2,(u+g)/2,Y.label).attr({fill:"#000","font-size":Y["font-size"]||"12px"}))),Y&&Y.label&&Y["label-style"]&&D.label&&D.label.attr(Y["label-style"]),Y&&Y.callback&&Y.callback(D)}};return D.draw(),D};var AbstractEdge=function(){};AbstractEdge.prototype={hide:function(){this.connection.fg.hide(),this.connection.bg&&this.bg.connection.hide()}};var EdgeFactory=function(){this.template=new AbstractEdge,this.template.style=new Object,this.template.style.directed=!1,this.template.weight=1};EdgeFactory.prototype={build:function(t,e){var i=jQuery.extend(!0,{},this.template);return i.source=t,i.target=e,i}};var Graph=function(){this.nodes={},this.edges=[],this.snapshots=[],this.edgeFactory=new EdgeFactory};function log(t){console.log&&console.log(t)}Graph.prototype={addNode:function(t,e){return null==this.nodes[t]&&(this.nodes[t]=new Graph.Node(t,e)),this.nodes[t]},addEdge:function(t,e,i){var a=this.addNode(t),o=this.addNode(e),s=this.edgeFactory.build(a,o);jQuery.extend(s.style,i),a.edges.push(s),this.edges.push(s),o.edges.push(s)},snapShot:function(t){},removeNode:function(t){delete this.nodes[t];for(var e=0;e<this.edges.length;e++)this.edges[e].source.id!=t&&this.edges[e].target.id!=t||(this.edges.splice(e,1),e--)}},Graph.Node=function(t,e){return(e=e||{}).id=t,e.edges=[],e.hide=function(){for(i in this.hidden=!0,this.shape&&this.shape.hide(),this.edges)this.edges[i].source.id!=t&&this.edges[i].target!=t||!this.edges[i].hide||this.edges[i].hide()},e.show=function(){for(i in this.hidden=!1,this.shape&&this.shape.show(),this.edges)this.edges[i].source.id!=t&&this.edges[i].target!=t||!this.edges[i].show||this.edges[i].show()},e},Graph.Node.prototype={},Graph.Renderer={},Graph.Renderer.Raphael=function(t,e,i,a){this.width=i||400,this.height=a||400;var r=this;this.r=Raphael(t,this.width,this.height),this.radius=40,this.graph=e,this.mouse_in=!1,this.graph.render||(this.graph.render=function(){}),this.isDrag=!1,this.dragger=function(t){this.dx=t.clientX,this.dy=t.clientY,(r.isDrag=this).set&&this.set.animate({"fill-opacity":.1},200)&&this.set.toFront(),t.preventDefault&&t.preventDefault()};var o=document.getElementById(t);o.onmousemove=function(t){if(t=t||window.event,r.isDrag){var e=r.isDrag.set.getBBox(),i=t.clientX-r.isDrag.dx+(e.x+e.width/2),a=t.clientY-r.isDrag.dy+(e.y+e.height/2),o=t.clientX-(i<20?i-20:i>r.width-20?i-r.width+20:0),s=t.clientY-(a<20?a-20:a>r.height-20?a-r.height+20:0);for(var h in r.isDrag.set.translate(o-Math.round(r.isDrag.dx),s-Math.round(r.isDrag.dy)),r.graph.edges)r.graph.edges[h].connection&&r.graph.edges[h].connection.draw();r.isDrag.dx=o,r.isDrag.dy=s}},o.onmouseup=function(){r.isDrag&&r.isDrag.set.animate({"fill-opacity":.6},500),r.isDrag=!1},this.draw()},Graph.Renderer.Raphael.prototype={translate:function(t){return[(t[0]-this.graph.layoutMinX)*this.factorX+this.radius,(t[1]-this.graph.layoutMinY)*this.factorY+this.radius]},rotate:function(t,e,i){var a=e*Math.cos(i),o=e*Math.sin(i);return[t[0]+a,t[1]+o]},draw:function(){for(t in this.factorX=(this.width-2*this.radius)/(this.graph.layoutMaxX-this.graph.layoutMinX),this.factorY=(this.height-2*this.radius)/(this.graph.layoutMaxY-this.graph.layoutMinY),this.graph.nodes)this.drawNode(this.graph.nodes[t]);for(var t=0;t<this.graph.edges.length;t++)this.drawEdge(this.graph.edges[t])},drawNode:function(t){var o,e=this.translate([t.layoutPosX,t.layoutPosY]);if(t.point=e,t.shape){var i=t.shape.getBBox(),a=i.x+i.width/2,s=i.y+i.height/2;return t.shape.translate(Math.round(e[0]-a),Math.round(e[1]-s)),this.r.safari(),t}t.render||(t.render=function(t,e){var i=Raphael.getColor(),a=t.ellipse(0,0,30,20).attr({fill:i,stroke:i,"stroke-width":2});return a.node.id=e.label||e.id,o=t.set().push(a).push(t.text(0,30,e.label||e.id))}),t.shapes,(o=t.render(this.r,t).hide()).attr({"fill-opacity":.6}),o.items.forEach(function(t){t.set=o,t.node.style.cursor="move"}),o.mousedown(this.dragger);var h=o.getBBox();o.translate(Math.round(e[0]-(h.x+h.width/2)),Math.round(e[1]-(h.y+h.height/2))),t.hidden||o.show(),t.shape=o},drawEdge:function(t){if(!t.backedge)if(t.source.hidden||t.target.hidden)t.connection&&t.connection.fg.hide()|t.connection.bg&&t.connection.bg.hide();else{if(!t.connection)return t.style&&t.style.callback&&t.style.callback(t),void(t.connection=this.r.connection(t.source.shape,t.target.shape,t.style));t.connection.fg.show(),t.connection.bg&&t.connection.bg.show(),t.connection.draw()}}},Graph.Layout={},Graph.Layout.Spring=function(t){this.graph=t,this.iterations=500,this.maxRepulsiveForceDistance=6,this.k=2,this.c=.01,this.maxVertexMovement=.5,this.layout()},Graph.Layout.Spring.prototype={layout:function(){this.layoutPrepare();for(var t=0;t<this.iterations;t++)this.layoutIteration();this.layoutCalcBounds()},layoutPrepare:function(){for(i in this.graph.nodes){var t=this.graph.nodes[i];t.layoutPosX=0,t.layoutPosY=0,t.layoutForceX=0,t.layoutForceY=0}},layoutCalcBounds:function(){var t=1/0,e=-1/0,a=1/0,o=-1/0;for(i in this.graph.nodes){var s=this.graph.nodes[i].layoutPosX,h=this.graph.nodes[i].layoutPosY;e<s&&(e=s),s<t&&(t=s),o<h&&(o=h),h<a&&(a=h)}this.graph.layoutMinX=t,this.graph.layoutMaxX=e,this.graph.layoutMinY=a,this.graph.layoutMaxY=o},layoutIteration:function(){var t=new Array;for(var e in this.graph.nodes){var i=this.graph.nodes[e];for(var a in t){var o=this.graph.nodes[t[a]];this.layoutRepulsive(i,o)}t.push(e)}for(var s=0;s<this.graph.edges.length;s++){var h=this.graph.edges[s];this.layoutAttractive(h)}for(s in this.graph.nodes){var r=this.graph.nodes[s],n=this.c*r.layoutForceX,d=this.c*r.layoutForceY,l=this.maxVertexMovement;l<n&&(n=l),n<-l&&(n=-l),l<d&&(d=l),d<-l&&(d=-l),r.layoutPosX+=n,r.layoutPosY+=d,r.layoutForceX=0,r.layoutForceY=0}},layoutRepulsive:function(t,e){if(void 0!==t&&void 0!==e){var i=e.layoutPosX-t.layoutPosX,a=e.layoutPosY-t.layoutPosY;if((o=i*i+a*a)<.01)var o=(i=.1*Math.random()+.1)*i+(a=.1*Math.random()+.1)*a;var s=Math.sqrt(o);if(s<this.maxRepulsiveForceDistance){var h=this.k*this.k/s;e.layoutForceX+=h*i/s,e.layoutForceY+=h*a/s,t.layoutForceX-=h*i/s,t.layoutForceY-=h*a/s}}},layoutAttractive:function(t){var e=t.source,i=t.target,a=i.layoutPosX-e.layoutPosX,o=i.layoutPosY-e.layoutPosY;if((s=a*a+o*o)<.01)var s=(a=.1*Math.random()+.1)*a+(o=.1*Math.random()+.1)*o;var h=Math.sqrt(s);h>this.maxRepulsiveForceDistance&&(s=(h=this.maxRepulsiveForceDistance)*h);var r=(s-this.k*this.k)/this.k;null==t.attraction&&(t.attraction=1),r*=.5*Math.log(t.attraction)+1,i.layoutForceX-=r*a/h,i.layoutForceY-=r*o/h,e.layoutForceX+=r*a/h,e.layoutForceY+=r*o/h}},Graph.Layout.Ordered=function(t,e){this.graph=t,this.order=e,this.layout()},Graph.Layout.Ordered.prototype={layout:function(){this.layoutPrepare(),this.layoutCalcBounds()},layoutPrepare:function(t){for(i in this.graph.nodes){(a=this.graph.nodes[i]).layoutPosX=0,a.layoutPosY=0}var e=0;for(i in this.order){var a;(a=this.order[i]).layoutPosX=e,a.layoutPosY=Math.random(),e++}},layoutCalcBounds:function(){var t=1/0,e=-1/0,a=1/0,o=-1/0;for(i in this.graph.nodes){var s=this.graph.nodes[i].layoutPosX,h=this.graph.nodes[i].layoutPosY;e<s&&(e=s),s<t&&(t=s),o<h&&(o=h),h<a&&(a=h)}this.graph.layoutMinX=t,this.graph.layoutMaxX=e,this.graph.layoutMinY=a,this.graph.layoutMaxY=o}},Raphael.el.tooltip=function(t){return this.tp=t,this.tp.o={x:0,y:0},this.tp.hide(),this.hover(function(t){this.mousemove(function(t){this.tp.translate(t.clientX-this.tp.o.x,t.clientY-this.tp.o.y),this.tp.o={x:t.clientX,y:t.clientY}}),this.tp.show().toFront()},function(t){this.tp.hide(),this.unmousemove()}),this},Array.prototype.forEach||(Array.prototype.forEach=function(t){var e=this.length;if("function"!=typeof t)throw new TypeError;for(var i=arguments[1],a=0;a<e;a++)a in this&&t.call(i,this[a],a,this)});
